---
title: "Full dataset analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(png)
library(knitr)
library(markdown)
library(lmerTest)
library(ggthemes)
library(psych)
library(magrittr)
library(tidyboot)
library(fs)
library(ggmap)
library(lubridate)

source(path(here::here(), "file_paths.R"))
source(functions_script)

#Variables to tinker with
min_completion_time = 8.5
```

First read in all of the relevant data.

```{r message=FALSE}
all_ws_1 <- 
  readInWebCDI(all_data_ws1_path) %>% 
  select( #drop a bunch of columns that were screwing up the merge with prolific data
    -opt_out,
    -country,
    -sibling_boolean,
    -sibling_data,
    -sibling_count,
    -caregiver_other
  )

all_ws_2 <- 
  readInWebCDI(all_data_ws2_path) %>% 
  select( #drop a bunch of columns that were screwing up the merge with prolific data
    -opt_out,
    -country,
    -sibling_boolean,
    -sibling_data,
    -sibling_count,
    -caregiver_other
  )

all_ws_raw <- 
  all_ws_1 %>% 
  bind_rows(all_ws_2) %>% 
  mutate(completed = case_when(
    stringr::str_to_lower(completed) == "true" ~ TRUE,
    stringr::str_to_lower(completed) == "false" ~ FALSE
  ))

all_wg_raw <- readInWebCDI(all_data_wg_path)

save(
  all_ws_raw,
  file = path(
    project_root,
    "data",
    "full_dataset",
    "unfiltered",
    "ws_unfiltered.RData"
  )
)

save(
  all_wg_raw,
  file = path(
    project_root,
    "data",
    "full_dataset",
    "unfiltered",
    "wg_unfiltered.RData"
  )
)
```


Filter out: multilingual exposure, illnesses, vision and hearing problems.
```{r}

#WG
wg_filtered <- 
  all_wg_raw %>% 
  filterIllnesses() %>% 
  filterBirthweight() %>% 
  filterMultilingual() %>% 
  filterVision() %>% 
  filterHearing() %>% 
  getEthnicities() %>% 
  getMaternalEd() %>%
  getCompletionInterval() %>% 
  filter(completion_time > min_completion_time) %>% 
  filter(completedBackgroundInfo == "TRUE") %>% #get rid of kids without demo info
  filter_age_wg()

save(
  wg_filtered,
  file = path(
    project_root, 
    "data", 
    "full_dataset", 
    "filtered", 
    "wg_filtered.RData"
  )
)

ws_filtered <- 
  all_ws_raw %>% 
  filterIllnesses() %>% 
  filterBirthweight() %>% 
  filterMultilingual() %>% 
  filterVision() %>% 
  filterHearing() %>% 
  getEthnicities() %>% 
  getMaternalEd() %>% 
  getCompletionInterval() %>% 
  filter(completion_time > min_completion_time) %>% 
  filter(completedBackgroundInfo == "TRUE") %>% 
  filter_age_ws()

save(
  ws_filtered,
  file = path(
    project_root, 
    "data", 
    "full_dataset", 
    "filtered", 
    "ws_filtered.RData"
  )
)


```


```{r}
#Comprehension and production measures
ws_filtered %>% 
  filter(`Total Produced` < 688 & !is.na(maternal_ed)) %>% 
  ggplot(aes(age, `Total Produced`, color = maternal_ed)) +
  ggthemes::theme_few() +
  geom_jitter(alpha = 0.3, width = 0.225) +
  coord_cartesian(ylim = c(0, 686)) +
  geom_smooth(method = "lm") +
  labs(
    x = "Age in months", 
    y = "Total words produced",
    color = "Maternal education"
  )

wg_filtered %>% 
  filter(!is.na(maternal_ed)) %>% 
  ggplot(aes(age, `Words Understood`, color = maternal_ed)) +
  ggthemes::theme_few() +
  geom_jitter(alpha = 0.3, width = 0.225) +
  geom_smooth(method = "lm") +
  coord_cartesian(ylim = c(0, 390)) +
  labs(
    x = "Age in months", 
    y = "Total words understood",
    color = "Maternal education"
  )
```


```{r}
#Demographic analyses on the entire sample

demographics_df <- 
  bind_rows(
    wg_filtered %>% 
      select(
        study_name,
        subject_id,
        age,
        ethnicity, 
        maternal_ed, 
        words_produced = `Words Produced` 
      ),
    ws_filtered %>% 
      select(
        study_name,
        subject_id,
        age,
        ethnicity,
        maternal_ed,
        words_produced = `Total Produced`
      )
  )

ethnicity_plot_df <- 
  demographics_df %>% 
  getEthnicitySummary() %>% 
  filter(!is.na(ethnicity)) %>% 
  mutate(`Current study` = prop.table(n)) %>% 
  left_join(old_ethnicity_numbers, by = "ethnicity") %>% 
  select(-n) %>% 
  pivot_longer(
    cols = c(`Current study`, `2007 manual`),
    names_to = "study",
    values_to = "proportion"
  )

ethnicity_plot <-
  ethnicity_plot_df %>% 
  ggplot(aes(ethnicity, proportion, fill = study)) +
  geom_col(position = "dodge") +
  labs(
    y = "Proportion of\nrespondents"
  ) +
  theme_few() +
  theme(
    legend.title = element_blank(),
    axis.text = element_text(size = 14),
    axis.title = element_text(size = 13),
    legend.text = element_text(size = 13),
    axis.title.x = element_blank(),
    plot.title = element_text(size = 15),
    plot.caption = element_text(hjust = 0)
  )

ethnicity_plot

```


```{r}
#Maternal ed analysis on the full sample

maternal_ed_plot_df <- 
  demographics_df %>% 
  count(maternal_ed) %>% 
  mutate(`Current study` = prop.table(n)) %>% 
  left_join(old_momed_numbers, by = "maternal_ed") %>% 
  select(-n) %>% 
  pivot_longer(
    cols = c(`Current study`, `2007 manual`),
    names_to = "study",
    values_to = "proportion"
  ) %>% 
  mutate(
    maternal_ed = fct_relevel(
      maternal_ed,
      "Some high school or less",
      "High school diploma",
      "Some college education",
      "College diploma or more"
    )
  ) %>% 
  filter(!is.na(maternal_ed))

x_axis_labs <- c(
  "Some high school\n or less",
  "High school\ndiploma",
  "Some college\neducation",
  "College diploma\nor more"
)

maternal_ed_plot <- 
  maternal_ed_plot_df %>% 
  ggplot(aes(maternal_ed, proportion, fill = study)) +
  geom_col(position = "dodge") +
  theme_few() +
  theme(
    legend.title = element_blank(),
    axis.text.x = element_text(angle = 30, vjust = 0.9, hjust = 1, size = 13.5),
    axis.title.x = element_blank(),
    legend.text = element_text(size = 13),
    plot.caption = element_text(hjust = 0)
  ) +
  scale_x_discrete(labels = x_axis_labs)

maternal_ed_plot
```


```{r wg_exclusions}

#Trying to figure out exclusion numbers.

wg_exclusions <- 
  all_wg_raw %>% 
  mutateBirthweight() %>% 
  mutateMultilingual() %>% 
  getCompletionInterval() %>% 
  mutate(
    exclusion_illness = case_when(illnesses_exclude == "1" ~ 1, TRUE ~ 0),
    exclusion_birthweight = as.numeric(premature),
    exclusion_multilingual = 
      as.numeric(!(is.na(language_hours_per_week)) & 
                   language_hours_per_week >= 16),
    exclusion_vision = case_when(vision_exclude == "1" ~ 1, TRUE ~ 0),
    exclusion_hearing = case_when(hearing_exclude == "1" ~ 1, TRUE ~ 0),
    exclusion_demographics = case_when(
      completedBackgroundInfo == "FALSE" ~ 1,
      TRUE ~ 0
    ),
    exclusion_minimum_time = as.numeric(completion_time < min_completion_time),
  ) %>% 
  mutate(
    quantity_exclusions = select(
      ., 
      exclusion_illness:exclusion_minimum_time
    ) %>% 
      rowSums()
  ) %>% 
  getEthnicities() %>% 
  getMaternalEd() %>% 
  select(study_name, subject_id, contains("exclusion"), ethnicity, maternal_ed)

#Of the kids who only failed one exclusion criterion, what was their breakdown?
wg_one_exclusion_count <- 
  wg_exclusions %>% 
  filter(quantity_exclusions == 1) %>% 
  pivot_longer(
    cols = starts_with("exclusion"),
    names_to = "exclusion",
    values_to = "exclude"
  ) %>% 
  filter(exclude == 1) %>% 
  count(exclusion)

#How many of each type of exclusion was there?
wg_exclusions_count <- 
  wg_exclusions %>% 
  pivot_longer(
    cols = starts_with("exclusion"),
    names_to = "exclusion",
    values_to = "exclude"
  ) %>% 
  filter(exclude == 1) %>% 
  count(exclusion)

total_n_wg_exclusions <- 
  wg_exclusions %>% 
  filter(quantity_exclusions > 0) %>% 
  nrow()

more_than_one_exclusion_wg <- 
  wg_exclusions %>% 
  filter(quantity_exclusions > 1) %>% 
  nrow()
  



```

```{r}

ws_exclusions <- 
  all_ws_raw %>% 
  mutateBirthweight() %>% 
  mutateMultilingual() %>% 
  getCompletionInterval() %>% 
  mutate(
    exclusion_illness = case_when(illnesses_exclude == "1" ~ 1, TRUE ~ 0),
    exclusion_birthweight = as.numeric(premature),
    exclusion_multilingual = 
      as.numeric(!(is.na(language_hours_per_week)) & 
                   language_hours_per_week >= 16),
    exclusion_vision = case_when(vision_exclude == "1" ~ 1, TRUE ~ 0),
    exclusion_hearing = case_when(hearing_exclude == "1" ~ 1, TRUE ~ 0),
    exclusion_demographics = case_when(
      completedBackgroundInfo == "FALSE" ~ 1,
      TRUE ~ 0
    ),
    exclusion_minimum_time = as.numeric(completion_time < min_completion_time),
  ) %>% 
  mutate(
    quantity_exclusions = select(
      ., 
      exclusion_illness:exclusion_minimum_time
    ) %>% 
      rowSums()
  ) %>% 
  getEthnicities() %>% 
  getMaternalEd() %>% 
  select(study_name, subject_id, contains("exclusion"), ethnicity, maternal_ed)

#Of the kids who only failed one exclusion criterion, what was their breakdown?
ws_one_exclusion_count <- 
  ws_exclusions %>% 
  filter(quantity_exclusions == 1) %>% 
  pivot_longer(
    cols = starts_with("exclusion"),
    names_to = "exclusion",
    values_to = "exclude"
  ) %>% 
  filter(exclude == 1) %>% 
  count(exclusion)

#How many of each type of exclusion were there?
ws_exclusions_count <- 
  ws_exclusions %>% 
  pivot_longer(
    cols = starts_with("exclusion"),
    names_to = "exclusion",
    values_to = "exclude"
  ) %>% 
  filter(exclude == 1) %>% 
  count(exclusion)

total_n_ws_exclusions <- 
  ws_exclusions %>% 
  filter(quantity_exclusions > 0) %>% 
  nrow()

more_than_one_exclusion_ws <- 
  ws_exclusions %>% 
  filter(quantity_exclusions > 1) %>% 
  nrow()
```

